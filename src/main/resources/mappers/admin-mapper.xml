<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="adminMapper">

	<!-- 단축 설정 -->
	<resultMap type="com.project.trinity.member.model.vo.Member"
		id="memberResultSet">
		<result column="USER_NO" property="userNo" />
		<result column="USER_ID" property="userId" />
		<result column="USER_PWD" property="userPwd" />
		<result column="USER_NAME" property="userName" />
		<result column="EMAIL" property="email" />
		<result column="PHONE" property="phone" />
		<result column="BIRTHDAY" property="birthday" />
		<result column="GENDER" property="gender" />
		<result column="ADDRESS" property="address" />
		<result column="ENROLL_DATE" property="enrollDate" />
		<result column="STATUS" property="status" />
		<result column="ISADMIN" property="isAdmin" />
		<result column="MED_KEY" property="medKey" />
		<result column="HOS_NO" property="hosNo" />
		<result column="USERPROFILE" property="userProfile" />
	</resultMap>

	<resultMap id="rankupResultSet" type="Rankup">
		<result column="SEQ_NO" property="seqNo" />
		<result column="USER_NO" property="userNo" />
		<result column="RES_TITLE" property="resTitle" />
		<result column="SUBJECT" property="subject" />
		<result column="LIC_PICTURE" property="licPicture" />
		<result column="STATUS" property="status" />
		<result column="USER_NAME" property="userName" />
		<result column="USER_ID" property="userId" />
		<result column="EMAIL" property="email" />
		<result column="PHONE" property="phone" />
	</resultMap>

	<resultMap id="medicalFieldResultMap" type="MedicalField">
		<result property="medNo" column="MED_NO" />
		<result property="job" column="JOB" />
		<result property="medicalFieldId" column="MEDICAL_FIELD_ID" />
	</resultMap>




	<!-- 관리자 회원 목록 조회 -->
	<select id="getAllMembers" resultMap="memberResultSet">
		SELECT USER_NO,
		USER_ID,
		USER_NAME,
		EMAIL,
		PHONE,
		BIRTHDAY,
		GENDER,
		ADDRESS,
		ENROLL_DATE,
		STATUS,
		ISADMIN,
		MED_KEY,
		HOS_NO
		FROM MEMBER
	</select>

	<!-- 등업 신청 데이터 조회 -->
	<select id="getAllRankups" resultMap="rankupResultSet">
		SELECT
		R.SEQ_NO,
		R.USER_NO,
		R.RES_TITLE,
		R.SUBJECT,
		R.LIC_PICTURE,
		R.STATUS,
		M.USER_NAME
		FROM RANKUP R
		JOIN MEMBER M
		ON R.USER_NO = M.USER_NO
	</select>

	<select id="getRankupDetail" parameterType="String"
		resultMap="rankupResultSet">
		SELECT
		r.SEQ_NO,
		r.USER_NO,
		r.RES_TITLE,
		r.SUBJECT,
		r.LIC_PICTURE,
		r.STATUS,
		m.USER_NAME,
		m.EMAIL,
		m.PHONE,
		m.USER_ID
		FROM
		RANKUP r
		JOIN
		MEMBER m
		ON
		r.USER_NO = m.USER_NO
		WHERE
		r.SEQ_NO = #{seqNo}
	</select>

	<!-- 등업 신청 상태 업데이트 -->
	<!-- medical_field 데이터 삽입 -->
	<insert id="insertMedicalField" parameterType="map">
		INSERT INTO
		MEDICAL_FIELD (MED_NO, JOB, MEDICAL_FIELD_ID)
		VALUES (#{medNo}, '의사',
		#{subject})
	</insert>

	<!-- member 테이블의 med_key 업데이트 -->
	<update id="updateMemberMedKey" parameterType="map">
		UPDATE MEMBER
		SET MED_KEY = #{medNo} <!-- Member의 medKey는 MEDICAL_FIELD의 medNo -->
		WHERE USER_NO = #{userNo}
	</update>
	<!-- rankup 상태 업데이트 -->
	<update id="updateRankupStatus">
		UPDATE RANKUP
		SET STATUS = #{status}
		WHERE SEQ_NO = #{seqNo}
	</update>

	<select id="getNextMedNo" resultType="string">
		SELECT 'M' ||
		SEQ_MED_NO.NEXTVAL FROM DUAL
	</select>
	

	<!-- member 테이블의 med_key를 null로 업데이트 -->
	<update id="resetMemberMedKey" parameterType="string">
		UPDATE MEMBER
		SET MED_KEY = NULL
		WHERE USER_NO = #{userNo}
	</update>

	<!-- MEDICAL_FIELD 존재 여부 확인 -->
	<select id="checkMedicalFieldExists" parameterType="string"
		resultType="int">
		SELECT COUNT(*) FROM MEDICAL_FIELD WHERE MED_NO = #{medNo}
	</select>

	<!-- medical_field 데이터를 medNo로 가져오기 -->
	<select id="getMedicalFieldByMedKey" parameterType="string"
		resultMap="medicalFieldResultMap">
		SELECT MED_NO, JOB, MEDICAL_FIELD_ID
		FROM MEDICAL_FIELD
		WHERE MED_NO = #{medNo} <!-- 정확히 medNo 사용 -->
	</select>

	<!-- 특정 userNo에 해당하는 medKey 조회 -->
	<select id="getMedKeyByUserNo" parameterType="string"
		resultType="string">
		SELECT MED_KEY
		FROM MEMBER
		WHERE USER_NO = #{userNo}
	</select>



</mapper>